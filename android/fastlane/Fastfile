default_platform(:android)

platform :android do
  desc "Runs all the tests"
  lane :test do
    gradle(task: "test")
  end

  desc "Submit new beta build for testing"
  lane :beta do
     sh "flutter build appbundle -v --build-number #{ENV['GITVERSION_BUILDMETADATA']} --build-name #{ENV['GITVERSION_MAJORMINORPATCH']} --release"
        firebase_app_distribution(
          app: "1:598133513450:android:9712712105eab7478e0b93",
          testers: "hirathameem@ymail.com",
          release_notes: "Lots of amazing new features to test out!" ,
          firebase_cli_token: ENV['FIREBASE_TOKEN_STARTUP1'],
          android_artifact_type: "AAB",
          android_artifact_path: '../build/app/outputs/bundle/release/app-release.aab'
        )
     end
  
  
  #Increase version code

  # lane :increment_version_code do
  #   version_code = google_play_track_version_codes(
  #     package_name: "com.nathira.startup1",  #e.g. com.xyz.app
  #     track: "internal",                #e.g. alpha
  #     json_key: "service_account_key.json",
  #    )
     
  #    version_code_play_store = version_code[0].to_i
  #    update_version_code = version_code_play_store + 1
     
  #    increment_version_code(
  #     gradle_file_path: "/Users/salimnathira/AndroidStudioProjects/startup1/android/app/build.gradle",
  #     version_code: update_version_code.to_i
  #    )
  # end
  

  #Internal Script
  desc "Submit a new Internal Build to Play Store"
  lane :internal do 
    
    # sh "flutter build appbundle"
    Dir.chdir "../.." do sh("flutter", "build", "appbundle", "--release") end
    upload_to_play_store(
      track: 'internal',package_name: 'com.nathira.startup1', 
      version_code: flutter_version()["version_code"],
      aab: '../build/app/outputs/bundle/release/app-release.aab',
      json_key: "private_service_account_key.json"
    )
    end

  # #Deploy to Alpha lane
  # desc "Submit to Alpha lane in Play Store"
  # lane :alpha do 
  #   upload_to_play_store(
  #     track: 'alpha',
  #     package_name: 'com.nathira.startup1', 
  #     aab: '../build/app/outputs/bundle/release/app-release.aab',
  #     json_key: "service_account_key.json"
  #   )
  #   end

  #Deploy to Beta lane
  # desc "Submit to Beta lane in Play Store"
  # lane :beta do 
  #   upload_to_play_store(
  #     track: 'beta',
  #     package_name: 'com.nathira.startup1', 
  #     aab: '../build/app/outputs/bundle/release/app-release.aab',
  #     json_key: "service-account-key.json"
  #   )
  #   end

#Production script

  desc "Deploy to production"
  lane :playstore do
      Dir.chdir "../.." do sh("flutter", "build", "appbundle", "--release") end
      upload_to_play_store(
         package_name: 'com.nathira.startup1', 
         track: 'production', 
         version_code: flutter_version()["version_code"],
         aab: '../build/app/outputs/bundle/release/app-release.aab',
         json_key: "private_service_account_key.json"
      )
      end
    end